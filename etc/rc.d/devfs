#!/bin/sh
#
# $FreeBSD$
#

# PROVIDE: devfs
# REQUIRE: mountcritremote
# BEFORE:  SERVERS securelevel
# KEYWORD: nojail

. /etc/rc.subr

name="devfs"
desc="Device filesystem"
start_cmd='devfs_start'
stop_cmd=':'

devfs_start()
{
	if [ -n "$devfs_system_ruleset" -o -n "$devfs_set_rulesets" ] ||
	    checkyesno devfs_load_rulesets; then
		devfs_init_rulesets
		if [ -n "$devfs_system_ruleset" ]; then
			devfs_set_ruleset $devfs_system_ruleset /dev
			devfs_apply_ruleset $devfs_system_ruleset /dev
		fi
		if [ -n "$devfs_set_rulesets" ]; then
			local _dir_set
			local _dir
			local _set
			for _dir_set in $devfs_set_rulesets; do
				_dir=${_dir_set%=*}
				_set=${_dir_set#*=}
				devfs_set_ruleset $_set $_dir
				devfs_apply_ruleset $_set $_dir
			done
		fi
	fi
	read_devfs_conf
}

read_devfs_conf()
{
	if [ -r /etc/devfs.conf ]; then
		while read action devicelist parameter; do
			case "${action}" in
			l*)	for device in ${devicelist}; do
					if [ ! -e /dev/${parameter} ]; then
						ln -fs /dev/${device} /dev/${parameter}
					fi
				done
				;;
			o*)	for device in ${devicelist}; do
					if [ -c /dev/${device} ]; then
						chown ${parameter} /dev/${device}
					fi
				done
				;;
			p*)	for device in ${devicelist}; do
					if [ -c /dev/${device} ]; then
						chmod ${parameter} /dev/${device}
					fi
				done
				;;
			esac
		done < /etc/devfs.conf
	fi
	
	for CONFIG in /etc/devfs.d/; do
		if [ -f /etc/devfs.d/"${CONFIG}" ] && [ -r /etc/devfs.d/"${CONFIG}" ]; then
		while read action devicelist parameter; do
			case "${action}" in
			l*)	for device in ${devicelist}; do
					if [ ! -e /dev/${parameter} ]; then
						ln -fs /dev/${device} /dev/${parameter}
					fi
				done
				;;
			o*)	for device in ${devicelist}; do
					if [ -c /dev/${device} ]; then
						chown ${parameter} /dev/${device}
					fi
				done
				;;
			p*)	for device in ${devicelist}; do
					if [ -c /dev/${device} ]; then
						chmod ${parameter} /dev/${device}
					fi
				done
				;;
			esac
		done < /etc/devfs.d/"${CONFIG}"
		fi
	done
}

load_rc_config $name
run_rc_command "$1"
