#!/bin/sh

BSDCFG_SHARE="/usr/share/bsdconfig"
. $BSDCFG_SHARE/common.subr || exit 1

: ${BSDDIALOG_OK=0}
: ${BSDDIALOG_CANCEL=1}
: ${BSDDIALOG_HELP=2}
: ${BSDDIALOG_EXTRA=3}
: ${BSDDIALOG_ESC=5}
: ${BSDDIALOG_RIGHT1=9}
: ${BSDDIALOG_ERROR=255}

kbdcontrol -d >/dev/null 2>&1
if [ $? -eq 0 ]; then
	# Syscons: use xterm, start interesting things on other VTYs
	TERM=xterm

	# Don't send ESC on function-key 62/63 (left/right command key)
	kbdcontrol -f 62 '' > /dev/null 2>&1
	kbdcontrol -f 63 '' > /dev/null 2>&1

	if [ -z "$EXTERNAL_VTY_STARTED" ]; then
		# Init will clean these processes up if/when the system
		# goes multiuser
		touch /tmp/bsdinstall_log
		tail -f /tmp/bsdinstall_log > /dev/ttyv2 &
		/usr/libexec/getty autologin ttyv3 &
		EXTERNAL_VTY_STARTED=1
	fi
else
	# Serial or other console
	echo
	echo "Welcome to ${OSNAME}!"
	echo
	echo "Please choose the appropriate terminal type for your system."
	echo "Common console types are:"
	echo "   ansi     Standard ANSI terminal"
	echo "   vt100    VT100 or compatible terminal"
	echo "   xterm    xterm terminal emulator (or compatible)"
	echo
	echo -n "Console type [vt100]: "
	read TERM
	TERM=${TERM:-vt100}
fi
export TERM

# Query terminal size; useful for serial lines.
resizewin -z

if [ -f /etc/installerconfig ]; then
	if [ "$1" != "primary" ]; then
		bsddialog --backtitle "${OSNAME} Installer" --title "Installing" --msgbox "${OSNAME} is being installed from a script; please use the primary console." 0 0
		. "$0"
	elif bsdinstall script /etc/installerconfig; then
		bsddialog --backtitle "${OSNAME} Installer" --title "Complete" --no-cancel --ok-label "Reboot" --pause "Installation of ${OSNAME} complete! Rebooting in 10 seconds" 10 30 10
		reboot
	else
		bsddialog --backtitle "${OSNAME} Installer" --title "Error" --textbox /tmp/bsdinstall_log 0 0
	fi
	exit 
fi

bsddialog --backtitle "${OSNAME} Installer" --title "Welcome" --extra-button --extra-label "Shell" --ok-label "Install" --cancel-label "Live System" \
	--right1-button "Repair" --yesno "Welcome to ${OSNAME}! Would you like to begin an installation or use the live system?" 0 0

case $? in
$BSDDIALOG_OK)	# Install
	# If not netbooting, have the installer configure the network
	dlv=`/sbin/sysctl -n vfs.nfs.diskless_valid 2> /dev/null`
	if [ ${dlv:=0} -eq 0 -a ! -f /etc/diskless ]; then
		BSDINSTALL_CONFIGCURRENT=yes; export BSDINSTALL_CONFIGCURRENT
	fi

	trap true SIGINT	# Ignore cntrl-C here
	bsdinstall
	if [ $? -eq 0 ]; then
		bsddialog --backtitle "${OSNAME} Installer" --title "Complete" --ok-label "Reboot" --extra-button --extra-label "Shutdown" --cancel-label "Live System" --yesno "Installation of ${OSNAME} complete! Would you like to reboot into the installed system now?" 0 0

		case $? in
		$BSDDIALOG_OK)		# Reboot
			reboot
			;;
		$BSDDIALOG_EXTRA)	# Shutdown
			shutdown -p now
			# shutdown(8) daemonizes, with the actual signal to
			# init(8) happening in the child, but if we exit the
			# script then runconsoles will clean up its children
			# thinking we're trying to go multiuser (and if the
			# user has disabled multiple console support we'll
			# still start trying to go multi-user, which gives
			# confusing output on the console if the daemon is slow
			# to run). Thus we spin while the daemon runs.
			while true; do
				sleep 1
			done
			;;
		$BSDDIALOG_CANCEL)	# Live System
			exit 0
			;;
		esac
	else
		. "$0"
	fi
	;;
$BSDDIALOG_CANCEL)	# Live System
	BSDINSTALL_CONFIGCURRENT=1 bsdinstall netconfig
	bsddialog --backtitle "$OSNAME Installer" --title 'Mount /usr/local (tmpfs)' \
		--yesno 'Would you like to mount a tmpfs under /usr/local?' 0 0
	if [ $? -eq $BSDDIALOG_OK ]; then
		mount -o size=700M -t tmpfs tmpfs /usr/local/
	fi
	bsddialog --backtitle "$OSNAME Installer" --title 'Bootstrap pkg' \
		--yesno 'Would you like to bootstrap pkg?' 0 0
	if [ $? -eq $BSDDIALOG_OK ]; then
		TMPDIR=/usr/local pkg bootstrap -fy
		echo "PKG_DBDIR = \"/usr/local/db/pkg\";" >> /usr/local/etc/pkg.conf
		echo "PKG_CACHEDIR = \"/usr/local/cache/pkg\";" >> /usr/local/etc/pkg.conf
		TMPDIR=/usr/local pkg update
	fi
	exit 0
	;;
$BSDDIALOG_EXTRA)	# Shell
	clear
	echo "When finished, type 'exit' to return to the installer."
	/bin/sh
	. "$0"
	;;
$BSDDIALOG_RIGHT1)
        partitions=$(gpart show -p | grep 'freebsd-ufs' | grep -v diskid |  awk '{ print $3, $4 }')
	pools=$(zpool import | grep pool: | awk '{ print $2, "freebsd-zfs" }')
	exec 5>&1
        part=$(echo $partitions $pools | xargs -o bsddialog --backtitle "${OSNAME} Installer" --title "Mount a partition" \
		--menu "Select one of the partitions to mount" 0 0 0 2>&1 1>&5)
	if [ $? -ne $BSDDIALOG_OK ]; then exit 0; fi
	fs=$(echo $partitions $pools | xargs -n 2 | grep $part | awk '{ print $2 }')
	if [ "$fs" == "freebsd-ufs" ]; then
		mount /dev/$part /mnt
		exec 5>&1
		checks=$(bsddialog --backtitle "$OSNAME Installer" --title 'Inspect selected partition' \
			--checklist 'Choose from the below commands to inspect partition' 0 0 0 \
			'fsck' 'fsck partition' on \
			'mtree' 'compare partition mtree with installation media mtree' on \
			2>&1 1>&5 )
		retval=$?
		exec 5>&-

		if [ $retval -ne $BSDDIALOG_OK ]; then
				exit 1
		fi

		for check in  $checks; do
			case "$check" in
			'fsck')
				echo "<=== FSCK ===>"
				echo
				fsck /dev/$part
				echo
				echo
				;;
			'mtree')
				echo "<=== MTREE ===>"
				echo
				mtree -e -p /mnt -f /etc/mtree/BSD.root.dist
				if [ $? -ne 0 ]; then
					while true; do
						read -p "Some changes were detected. Would you like to reset to defaults? [y/N] " yn
						case $yn in
							[Yy]* ) mtree -eu -p /mnt -f /etc/mtree/BSD.root.dist; break;;
							[Nn]* ) exit;;
							* ) ;;
						esac
					done
				fi
				;;
			esac
		done
	elif [ "$fs" == "freebsd-zfs" ]; then
	        mount -t tmpfs tmpfs /mnt
	        zpool import -o altroot=/mnt $part 
		zfs mount zroot/ROOT/default
		exec 5>&1
		checks=$(bsddialog --backtitle "$OSNAME Installer" --title 'Inspect selected partition' \
			--checklist 'Choose from the below commands to inspect partition' 0 0 0 \
			'scrub' 'zpool scrub pools' on \
			'mtree' 'compare partition mtree with installation media mtree' on \
			2>&1 1>&5 )
		retval=$?
		exec 5>&-

		if [ $retval -ne $BSDDIALOG_OK ]; then
				exit 1
		fi

		for check in  $checks; do
			case "$check" in
			'scrub')
				echo "<=== ZPOOL SCRUB ===>"
				echo
				zpool scrub zroot
				echo
				echo
				;;
			'mtree')
				echo "<=== MTREE ===>"
				echo
				mtree -e -p /mnt -f /etc/mtree/BSD.root.dist
				if [ $? -ne 0 ]; then
					while true; do
						read -p "Some changes were detected. Would you like to reset to defaults? [y/N] " yn
						case $yn in
							[Yy]* ) mtree -eu -p /mnt -f /etc/mtree/BSD.root.dist; break;;
							[Nn]* ) exit;;
							* ) ;;
						esac
					done
				fi
				;;
			esac
		done
	fi
esac

